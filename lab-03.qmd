---
title: "Lab 3: COVID-19"
subtitle: "Ecosystem Sciences and Sustainability 330"
author: 
  - name: https://andiehal.github.io/Andies-Website/
    email: andie.hal@colostate.edu
format: html
execute: 
  echo: true
---

## Library Codes

```{r}
library(tidyverse)
library(flextable)
library(zoo)
```

## Lab Questions

### Question 1: Public Data

-   Allowing for data to be accessible to the general public makes it a bit more believable that the facts generated from the data-set are true and unbias. When we put a cloak on information, it can make it hard to believe, as we humans prefer to see something to believe. Even if people do not have the experience or resources to create the data analysis themselves, they can at least look at the raw data and with proper documentation of how it's structured, you can somewhat understand the document. Public data is, in my opinion, one of the bridging aspects to science and public trust.

#### Data-set import

```{r}
url = "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
covid = read_csv(url)
head(covid, 5)

covid <- covid |>
  filter(state %in% c("California", "New York", "Colorado", "Ohio"))

```

### Question 2: Daily Summary 

Watch list of counties criteria -

1.  More than 100 new cases per 100,000 residents over the past 14 daysâ€¦

```{r}
# Creating Values
my.date <- as.Date("2022-02-01")
my.state <- "Colorado"

class(my.date)
class(my.state)
```

```{r}
# Creating Data Tables based on Cases/Deaths
selected_data <- covid |>
  filter(state == my.state) |>
  group_by(county) |>
  mutate(new_cases = cases - lag(cases),
         new_deaths = deaths - lag(deaths)) |>
    filter(date == my.date)

most_new_cases <- selected_data |>
  arrange(-new_cases) |>
  slice_max(new_cases, n = 5)

most_cases <- selected_data |>
  group_by(county) |>
  mutate(cumulative_cases = cumsum(cases)) |>
  ungroup() |>
  arrange(-cumulative_cases) |>
  slice_max(cumulative_cases, n = 5) 

```

### Question 3: Normalizing Data

```{r}
# Reading In the Data
pop_url <- 'https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/totals/co-est2023-alldata.csv'
population_census2 = read_csv(pop_url)
head(population_census2, 5)

```

```{r}
# Normalizing 
population_census <- population_census |>
  filter(STNAME == my.state) |>
  mutate(fips = paste0(STATE, COUNTY)) |>
  select(fips, contains("NAME", ignore.case = TRUE, vars = NULL) | contains("2021", ignore.case = TRUE, vars = NULL))
  
```

 3.2 The data has basically been filtered down to Colorado, and now can be matched with the 'fips' column from the covid data. 

```{r}
# Finding the Population Range in 2021
range_population <- range(population_census$POPESTIMATE2021)

print(range_population)

```

  3.3 The range of the population is between 741 and 5,811,596. 
  
  3.4 Joining the Data 

```{r}
#Creating the 2022-02-1 Joined Dataset
combined_pop_covid <- inner_join(selected_data, population_census, by = "fips")

capita_cases <- combined_pop_covid |>
  mutate(percapitacases = cases/POPESTIMATE2021,
         percapitanewcases = new_cases/POPESTIMATE2021,
         percapitanewdeaths = new_deaths/POPESTIMATE2021) |>
  select(county, fips, percapitacases, percapitanewcases, percapitanewdeaths) |>
  glimpse()

most_capita_cases <- capita_cases |>
  arrange(-percapitacases) |>
  slice_max(percapitacases, n = 5)

most_new_capita_cases <- capita_cases |>
  arrange(-percapitanewcases) |>
  slice_max(percapitanewcases, n = 5)

```

### Question 4: Rolling thresholds 

```{r}
# Creating a date format
combined_pop_covid$date <- as.Date(combined_pop_covid$date, format="%Y-%m-%d")

twoweekreport_covid <- covid |>
  filter(date >= (my.date - 14) & date < my.date)

twoweekreport_covid <- twoweekreport_covid |>
  left_join(population_census, by = "fips")

county_summary <- twoweekreport_covid |>
  group_by(county) |>
  mutate(new_cases = cases - lag(cases),
         new_deaths = deaths - lag(deaths)) |>
  summarise(total_cases_14d = sum(new_cases, na.rm = TRUE), countypopulation = first(POPESTIMATE2021)) |>
  mutate(cases_per_100k = (total_cases_14d / countypopulation) * 1000) |>
  arrange(-cases_per_100k) |>
  slice_max(cases_per_100k, n = 5)
  
```

The top 5 counties include Lincoln, Alamosa, Mineral, Conejos, and Fremont. 

### Question 5: Death Toll

```{r}

death_toll <- combined_pop_covid |>
  group_by(county) |>
  summarise(deathtollpercent = (deaths/DEATHS2021) * 100) |>
  ungroup() |>
  filter(deathtollpercent > 20) |>
  arrange(deathtollpercent)

ggplot(death_toll, aes(x = county, y = deathtollpercent)) +
  geom_bar(stat = "identity", fill = "indianred1", color = "indianred4") +
  labs(title = "Death Toll Percentage in Colorado Counties",
       x = "County",
       y = "Death Toll Percentage",
       caption = "Counties with death toll percentages over 20% in 2021") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
### Question 6: Multi-state

```{r}

multistate <- covid |>
  group_by(state) |>
  arrange(state, date) |>
  mutate(new_cases = cases - lag(cases)) |>
  ungroup()

multistate <- multistate |>
  group_by(state) |>
  mutate(new_cases_rollmean = rollmean(new_cases, k = 7, fill = NA, align = "right")) |>
  ungroup()

multistate <- multistate |>
  filter(date == my.date)

state_summary <- multistate |>
  group_by(state) |>
  summarise(mean_new_cases = mean(new_cases), mean_new_cases_rollmean = mean(new_cases_rollmean, na.rm = TRUE))

print(state_summary)

ggplot(state_summary, aes(x = state)) +
  # Bar for Mean New Cases
  geom_bar(aes(y = mean_new_cases, fill = "Mean New Cases"), stat = "identity", position = "dodge") +
  # Bar for Mean New Cases Rollout
  geom_bar(aes(y = mean_new_cases_rollmean, fill = "Mean New Cases Rollout"), stat = "identity", position = "dodge") +
  # Facet by state
  facet_wrap(~ state, scales = "free_y") +
  labs(
    title = "New Covid Cases Mean and Mean Rollout in CO, NY, CA, and OH",
    x = "State",
    y = "Cases/ Rollout",
    caption = "Average of new cases and new case rollout in CO, NY, CA, and OH"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values = c("Mean New Cases" = "blue", "Mean New Cases Rollout" = "red"))

```

